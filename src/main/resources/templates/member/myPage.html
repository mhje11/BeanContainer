<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Page</title>
    <link rel="stylesheet" href="/css/member/mypage.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div th:if="${#authentication.isAuthenticated()}">
    <div class="container" th:if="${#authentication.isAuthenticated()}">
        <h1>안녕하세요, <span th:text="${name}">사용자</span>님!</h1>

        <div class="profile-image" th:style="${profileImageUrl != null} ? 'background-image: url(' + ${profileImageUrl} + ')' : ''"></div>

        <div class="profile-upload">
            <form id="profileImageForm" enctype="multipart/form-data">
                <label for="file-upload">프로필 이미지 변경</label>
                <input id="file-upload" type="file" name="file" accept="image/*">
                <button type="submit">업로드</button>
            </form>
        </div>

    <p>닉네임: <span id="currentNickname" th:text="${nickname}"></span></p>
    <input type="text" id="newNickname" placeholder="새 닉네임">
    <button onclick="updateNickname()">닉네임 변경</button>

    <p>당신의 권한은: <span th:text="${authorities}"></span></p>

    <button onclick="deleteAccount()">회원 탈퇴</button>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    var userId = /*[[${userId}]]*/ 'defaultUserId';
    /*]]>*/

    function updateNickname() {
        var newNickname = $('#newNickname').val();
        $.post('/api/mypage/updateNickname', {userId: userId, newNickname: newNickname})
            .done(function() {
                $('#currentNickname').text(newNickname);
                alert('닉네임이 변경되었습니다.');
            })
            .fail(function() {
                alert('닉네임 변경에 실패했습니다.');
            });
    }

    $('#profileImageForm').submit(function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        formData.append('userId', userId);
        $.ajax({
            url: '/api/mypage/uploadProfileImage',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('.profile-image').css('background-image', 'url(' + response + ')');
                alert('프로필 이미지가 업데이트되었습니다.');
            },
            error: function() {
                alert('프로필 이미지 업로드에 실패했습니다.');
            }
        });
    });

    function deleteAccount() {
        if (confirm('정말로 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            $.post('/api/mypage/deleteAccount', {userId: userId})
                .done(function() {
                    alert('계정이 삭제되었습니다.');
                    window.location.href = '/';
                })
                .fail(function() {
                    alert('계정 삭제에 실패했습니다.');
                });
        }
    }
</script>
</body>
</html>