<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>지도 수정</title>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c1be6dbc09faa31e5316451aad20da0b&libraries=services,geometry"></script>
    <style>
        body {
            display: flex;
            flex-direction: row;
            font-family: Arial, sans-serif;
        }

        #map-container {
            position: relative;
            width: 70%;
            height: 600px;
            margin: 10px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #cafe-cards {
            position: absolute;
            top: 10px;
            right: 10px;
            max-height: 80%;
            overflow-y: auto;
            z-index: 1;
        }

        .cafe-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px;
            margin-bottom: 10px;
            width: 200px;
        }

        .cafe-card h4 {
            margin: 0 0 5px 0;
        }

        .cafe-card p {
            margin: 0;
            font-size: 12px;
        }

        .cafe-card button {
            margin-top: 5px;
            padding: 2px 5px;
            font-size: 12px;
        }

        #sidebar {
            width: 30%;
            height: 600px;
            margin: 10px;
            display: flex;
            flex-direction: column;
        }

        #search-box {
            margin-bottom: 10px;
            border: 1px solid #ccc;
            padding: 10px;
        }

        #search-results {
            overflow-y: auto;
            max-height: 200px;
        }

        #search-results div {
            cursor: pointer;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }

        #search-results div:hover {
            background-color: #f0f0f0;
        }

        #map-title {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }

        #save-btn {
            margin-top: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="map-container">
    <div id="map"></div>
    <div id="cafe-cards"></div>
</div>

<div id="sidebar">
    <div id="map-title">
        <label for="map-name">지도 이름:</label>
        <input type="text" id="map-name">
    </div>

    <div id="search-box">
        <input type="text" id="search-input" placeholder="카페 이름을 입력하세요">
        <button id="search-btn">검색</button>
        <div id="search-results"></div>
    </div>

    <button id="save-btn">지도 저장</button>
</div>

<script>
    let map, ps, infowindow, markers = {}, addedCafes = new Set();

    function initMap() {
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 3
        };

        map = new kakao.maps.Map(mapContainer, mapOption);
        infowindow = new kakao.maps.InfoWindow({zIndex: 1});

        const zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.LEFT);

        ps = new kakao.maps.services.Places();

        kakao.maps.event.addListener(map, 'click', function() {
            infowindow.close();
        });

        kakao.maps.event.addListener(map, 'dragend', function() {
            searchPlacesByCenter(map.getCenter());
        });

        kakao.maps.event.addListener(map, 'zoom_changed', function() {
            searchPlacesByCenter(map.getCenter());
        });

        loadMapDetails();
        searchPlacesByCenter(map.getCenter());
    }

    function loadMapDetails() {
        const mapId = window.location.pathname.split("/").pop();

        fetch(`/api/mymap/${mapId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('map-name').value = data.mapName;
                data.cafes.forEach(cafe => {
                    addCafeToSet(cafe.kakaoId, cafe.name, cafe.address);
                });
            })
            .catch(error => {
                console.error('지도 세부 정보 로드 오류:', error);
            });
    }

    function isExcludedCategory(categoryName) {
        const excludedCategories = ['보드게임카페', '룸카페', '방탈출카페', '테마카페', '고양이카페', '북카페', '레드버튼', '벌툰', '키즈'];
        return excludedCategories.some(excluded => categoryName.includes(excluded));
    }

    function searchPlacesByCenter(center) {
        const keyword = '카페';
        ps.keywordSearch(keyword, function(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                for (let i = 0; i < data.length; i++) {
                    if (!isExcludedCategory(data[i].category_name) && !markers[data[i].id]) {
                        displayMarker(data[i]);
                    }
                }
                if (pagination.hasNextPage) {
                    pagination.nextPage();
                }
            }
        }, {location: center, radius: 2000});
    }

    function displayMarker(place) {
        let markerImageUrl = addedCafes.has(place.id) ?
            "http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png" :
            null;

        let markerImage = markerImageUrl ?
            new kakao.maps.MarkerImage(markerImageUrl, new kakao.maps.Size(24, 35), { offset: new kakao.maps.Point(12, 35) }) :
            null;

        const marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.latitude || place.y, place.longitude || place.x),
            image: markerImage
        });

        markers[place.id] = marker;

        kakao.maps.event.addListener(marker, 'click', function () {
            openInfoWindow(marker, place);
        });
    }

    function addCafeToSet(kakaoId, name, address) {
        if (!addedCafes.has(kakaoId)) {
            addedCafes.add(kakaoId);

            const card = document.createElement('div');
            card.className = 'cafe-card';
            card.setAttribute('data-id', kakaoId);
            card.innerHTML = `
            <h4>${name}</h4>
            <p>${address}</p>
            <button onclick="removeCafe('${kakaoId}')">삭제</button>
            `;

            card.addEventListener('click', () => handleCardClick(kakaoId));

            document.getElementById('cafe-cards').appendChild(card);

            const marker = markers[kakaoId];
            if (marker) {
                const markerImageUrl = "http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
                const markerImage = new kakao.maps.MarkerImage(
                    markerImageUrl,
                    new kakao.maps.Size(24, 35),
                    { offset: new kakao.maps.Point(12, 35) }
                );
                marker.setImage(markerImage);
            }
        }
    }

    function handleCardClick(kakaoId) {
        const marker = markers[kakaoId];
        if (marker) {
            map.setCenter(marker.getPosition());

            // 인포윈도우가 열려 있으면 닫기
            if (infowindow.getMap()) {
                infowindow.close();
            }
        }
    }

    document.querySelectorAll('.cafe-card').forEach(card => {
        card.addEventListener('click', () => {
            const kakaoId = card.getAttribute('data-id');
            handleCardClick(kakaoId);
        });
    });

    function removeCafe(kakaoId) {
        addedCafes.delete(kakaoId);
        const card = document.querySelector(`.cafe-card[data-id="${kakaoId}"]`);
        if (card) {
            card.remove();
        }

        const marker = markers[kakaoId];
        if (marker) {
            marker.setImage(null);
        }
    }

    function saveMap() {
        const mapId = window.location.pathname.split("/").pop();
        const mapName = document.getElementById('map-name').value;
        const kakaoIds = Array.from(addedCafes);

        const mapData = {
            mapId: mapId,
            mapName: mapName,
            kakaoIds: kakaoIds
        };

        fetch(`/api/mymap/update/${mapId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(mapData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
                return response.text();
            })
            .then(data => {
                alert('지도 업데이트 성공!');
                window.location.href = '/';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('지도 업데이트 실패: ' + error.message);
            });
    }

    document.getElementById('search-btn').addEventListener('click', function() {
        const keyword = document.getElementById('search-input').value;
        ps.keywordSearch(keyword, function(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                const searchResultsContainer = document.getElementById('search-results');
                searchResultsContainer.innerHTML = '';
                data.forEach(place => {
                    if (!isExcludedCategory(place.category_name)) {
                        const resultItem = document.createElement('div');
                        resultItem.textContent = `${place.place_name} (${place.road_address_name || place.address_name})`;
                        resultItem.onclick = () => {
                            const center = new kakao.maps.LatLng(place.y, place.x);
                            map.setCenter(center);
                            map.setLevel(3);

                            searchPlacesByCenter(center);

                            setTimeout(() => {
                                if (markers[place.id]) {
                                    openInfoWindowForSearch(place);
                                } else {
                                    displayMarker(place);
                                    setTimeout(() => openInfoWindowForSearch(place), 500);
                                }
                            }, 500);

                            searchResultsContainer.innerHTML = '';
                        };
                        searchResultsContainer.appendChild(resultItem);
                    }
                });
            }
        });
    });
    function openInfoWindowForSearch(place) {
        const marker = markers[place.id];
        openInfoWindow(marker, place);
    }

    function openInfoWindow(marker, place) {
        const parsedAddress = parseAddress(place.road_address_name || place.address_name);
        const content = `
        <div style="padding:10px;">
            <strong>${place.name || place.place_name}</strong><br>
            ${place.road_address_name || place.address_name}<br>
            <button onclick="checkAndSaveCafe('${place.id}', '${place.name || place.place_name}', '${place.road_address_name || place.address_name}', ${marker.getPosition().getLat()}, ${marker.getPosition().getLng()}, '${parsedAddress.city}', '${parsedAddress.district}')">지도에 추가하기</button>
            <a href="#" onclick="openReviewPage('${place.id}', '${place.name || place.place_name}', '${place.road_address_name || place.address_name}', ${marker.getPosition().getLat()}, ${marker.getPosition().getLng()})">리뷰 페이지로 이동</a>
        </div>
    `;
        infowindow.setContent(content);
        infowindow.open(map, marker);
    }

    document.getElementById('search-btn').addEventListener('click', function() {
        const keyword = document.getElementById('search-input').value;
        ps.keywordSearch(keyword, function(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                const searchResultsContainer = document.getElementById('search-results');
                searchResultsContainer.innerHTML = '';
                data.forEach(place => {
                    if (!isExcludedCategory(place.category_name)) {
                        const resultItem = document.createElement('div');
                        resultItem.textContent = `${place.place_name} (${place.road_address_name || place.address_name})`;
                        resultItem.onclick = () => {
                            const center = new kakao.maps.LatLng(place.y, place.x);
                            map.setCenter(center);
                            map.setLevel(3);

                            searchPlacesByCenter(center);

                            setTimeout(() => {
                                if (markers[place.id]) {
                                    openInfoWindow(markers[place.id], place);
                                } else {
                                    displayMarker(place);
                                    setTimeout(() => openInfoWindow(markers[place.id], place), 500);
                                }
                            }, 500);

                            searchResultsContainer.innerHTML = '';
                        };
                        searchResultsContainer.appendChild(resultItem);
                    }
                });
            }
        });
    });

    document.getElementById('save-btn').addEventListener('click', saveMap);

    document.addEventListener('DOMContentLoaded', initMap);

    function parseAddress(address) {
        const parts = address.split(' ');
        let city = parts[0];
        let district = '';
        for (let i = 1; i < parts.length; i++) {
            if (parts[i].endsWith('구') || parts[i].endsWith('군')) {
                district = parts[i];
                break;
            }
        }
        return {city, district};
    }

    function checkAndSaveCafe(kakaoId, name, address, latitude, longitude, city, district) {
        const data = {
            kakaoId: kakaoId,
            name: name,
            address: address,
            latitude: latitude,
            longitude: longitude,
            city: city,
            district: district
        };

        console.log("Sending data:", data);

        fetch(`/review/${kakaoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
            return response.json();
        })
            .then(data => {
                console.log("Cafe saved or found:", data);
                addCafeToSet(kakaoId, name, address);
            }).catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });
    }

    function openReviewPage(kakaoId, name, address, latitude, longitude) {
        const parsedAddress = parseAddress(address);

        const data = {
            kakaoId: kakaoId,
            name: name,
            address: address,
            latitude: latitude,
            longitude: longitude,
            city: parsedAddress.city,
            district: parsedAddress.district
        };

        console.log("Sending data for review page:", data);

        fetch(`/review/${kakaoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text);
                });
            }
            return response.json();
        })
            .then(data => {
                console.log("Cafe saved or found:", data);
                window.open(`/review/${data.id}`, '_blank');
            }).catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });
    }
</script>

</body>
</html>


