<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review</title>
    <style>
        .star-rating {
            direction: rtl;
            display: inline-block;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
        }

        .star-rating input:checked ~ label,
        .star-rating input:hover ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f5c518;
        }

        .selected-categories {
            margin-top: 10px;
        }

        .selected-categories ul {
            list-style-type: none;
            padding: 0;
        }

        .selected-categories li {
            display: inline-block;
            margin-right: 5px;
            background-color: #e0e0e0;
            padding: 5px;
            border-radius: 3px;
        }

        .review-item {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .edit-form {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
<h2>Review</h2>

<div class="star-rating">
    <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">&#9733;</label>
    <input type="radio" id="4.5-stars" name="rating" value="4.5" /><label for="4.5-stars">&#9733;</label>
    <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">&#9733;</label>
    <input type="radio" id="3.5-stars" name="rating" value="3.5" /><label for="3.5-stars">&#9733;</label>
    <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">&#9733;</label>
    <input type="radio" id="2.5-stars" name="rating" value="2.5" /><label for="2.5-stars">&#9733;</label>
    <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">&#9733;</label>
    <input type="radio" id="1.5-stars" name="rating" value="1.5" /><label for="1.5-stars">&#9733;</label>
    <input type="radio" id="1-stars" name="rating" value="1" /><label for="1-stars">&#9733;</label>
    <input type="radio" id="0.5-stars" name="rating" value="0.5" /><label for="0.5-stars">&#9733;</label>
</div>

<h3>Categories</h3>
<div class="categories">
    <label><input type="checkbox" value="대형카페" /> 대형카페</label>
    <label><input type="checkbox" value="편한 좌석" /> 편한 좌석</label>
    <label><input type="checkbox" value="주차가 가능한" /> 주차가 가능한</label>
    <label><input type="checkbox" value="24시간 카페" /> 24시간 카페</label>
    <label><input type="checkbox" value="룸" /> 룸</label>
    <label><input type="checkbox" value="테라스" /> 테라스</label>
    <label><input type="checkbox" value="와이파이" /> 와이파이</label>
    <label><input type="checkbox" value="데이트 하기 좋은" /> 데이트 하기 좋은</label>
    <label><input type="checkbox" value="혼자가기 좋은" /> 혼자가기 좋은</label>
    <label><input type="checkbox" value="공부하기 좋은" /> 공부하기 좋은</label>
    <label><input type="checkbox" value="비즈니스 미팅" /> 비즈니스 미팅</label>
    <label><input type="checkbox" value="애견 동반" /> 애견 동반</label>
    <label><input type="checkbox" value="분위기 좋은" /> 분위기 좋은</label>
    <label><input type="checkbox" value="인스타 감성" /> 인스타 감성</label>
    <label><input type="checkbox" value="풍경이 좋은" /> 풍경이 좋은</label>
    <label><input type="checkbox" value="새로 오픈" /> 새로 오픈</label>
    <label><input type="checkbox" value="조용한" /> 조용한</label>
</div>

<h3>Selected Categories</h3>
<div class="selected-categories">
    <ul id="selected-category-list"></ul>
</div>

<h3>Review Content</h3>
<textarea id="review-content" rows="4" cols="50"></textarea>

<button id="submit-review">Submit Review</button>

<h3>Reviews</h3>
<div id="review-list"></div>

<script>
    const selectedCategories = new Set();
    let isEditing = false;
    let currentEditId = null;
    let reviewsData = [];

    document.querySelectorAll('.categories input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (event) => {
            if (event.target.checked) {
                selectedCategories.add(event.target.value);
            } else {
                selectedCategories.delete(event.target.value);
            }
            updateSelectedCategories();
        });
    });

    function updateSelectedCategories() {
        const selectedCategoryList = document.getElementById('selected-category-list');
        selectedCategoryList.innerHTML = '';
        selectedCategories.forEach(category => {
            const li = document.createElement('li');
            li.textContent = category;
            const button = document.createElement('button');
            button.textContent = 'x';
            button.onclick = () => {
                selectedCategories.delete(category);
                updateSelectedCategories();
            };
            li.appendChild(button);
            selectedCategoryList.appendChild(li);
        });
    }

    document.getElementById('submit-review').addEventListener('click', async () => {
        const rating = document.querySelector('input[name="rating"]:checked').value;
        const content = document.getElementById('review-content').value;
        const categoryNames = Array.from(selectedCategories);

        // URL에서 cafeId를 추출
        const path = window.location.pathname;
        const cafeId = path.split('/').filter(Boolean).pop();

        const reviewData = {
            score: rating,
            content: content,
            categoryNames: categoryNames,
            cafeId: cafeId
        };

        const url = isEditing ? `/api/review/update/${currentEditId}` : '/api/review/create';
        const method = isEditing ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reviewData)
            });

            if (response.ok) {
                alert('Review submitted successfully!');
                fetchReviews();
                isEditing = false;
                currentEditId = null;
                document.getElementById('review-content').value = '';
                document.querySelector('input[name="rating"]:checked').checked = false;
                selectedCategories.clear();
                updateSelectedCategories();
            } else {
                alert('Failed to submit review.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to submit review.');
        }
    });

    async function fetchReviews() {
        // URL에서 cafeId를 추출
        const path = window.location.pathname;
        const cafeId = path.split('/').filter(Boolean).pop();

        try {
            const response = await fetch(`/api/reviewlist/${cafeId}`);
            const reviews = await response.json();
            reviewsData = reviews;  // Save the fetched reviews data

            displayReviews(reviews);
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to fetch reviews.');
        }
    }

    function displayReviews(reviews) {
        const reviewList = document.getElementById('review-list');
        reviewList.innerHTML = '';

        reviews.forEach(review => {
            const div = document.createElement('div');
            div.className = 'review-item';
            div.innerHTML = `
                <p><strong>Rating:</strong> ${review.score}</p>
                <p><strong>Content:</strong> ${review.content}</p>
                <p><strong>Categories:</strong> ${review.categoryNames ? Array.from(review.categoryNames).join(', ') : 'None'}</p>
                <p><strong>Author:</strong> ${review.nickName}</p>
                <button onclick="showEditForm(${review.id})">Edit</button>
                <button onclick="deleteReview(${review.id})">Delete</button>
            `;

            const editForm = document.createElement('div');
            editForm.className = 'edit-form';
            editForm.style.display = 'none';
            editForm.innerHTML = `
                <textarea id="edit-content-${review.id}" rows="4" cols="50"></textarea>
                <div class="star-rating">
                    <input type="radio" id="edit-5-stars-${review.id}" name="edit-rating-${review.id}" value="5" /><label for="edit-5-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-4.5-stars-${review.id}" name="edit-rating-${review.id}" value="4.5" /><label for="edit-4.5-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-4-stars-${review.id}" name="edit-rating-${review.id}" value="4" /><label for="edit-4-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-3.5-stars-${review.id}" name="edit-rating-${review.id}" value="3.5" /><label for="edit-3.5-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-3-stars-${review.id}" name="edit-rating-${review.id}" value="3" /><label for="edit-3-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-2.5-stars-${review.id}" name="edit-rating-${review.id}" value="2.5" /><label for="edit-2.5-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-2-stars-${review.id}" name="edit-rating-${review.id}" value="2" /><label for="edit-2-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-1.5-stars-${review.id}" name="edit-rating-${review.id}" value="1.5" /><label for="edit-1.5-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-1-stars-${review.id}" name="edit-rating-${review.id}" value="1" /><label for="edit-1-stars-${review.id}">&#9733;</label>
                    <input type="radio" id="edit-0.5-stars-${review.id}" name="edit-rating-${review.id}" value="0.5" /><label for="edit-0.5-stars-${review.id}">&#9733;</label>
                </div>
                <div class="categories">
                    <label><input type="checkbox" value="대형카페" /> 대형카페</label>
                    <label><input type="checkbox" value="편한 좌석" /> 편한 좌석</label>
                    <label><input type="checkbox" value="주차가 가능한" /> 주차가 가능한</label>
                    <label><input type="checkbox" value="24시간 카페" /> 24시간 카페</label>
                    <label><input type="checkbox" value="룸" /> 룸</label>
                    <label><input type="checkbox" value="테라스" /> 테라스</label>
                    <label><input type="checkbox" value="와이파이" /> 와이파이</label>
                    <label><input type="checkbox" value="데이트 하기 좋은" /> 데이트 하기 좋은</label>
                    <label><input type="checkbox" value="혼자가기 좋은" /> 혼자가기 좋은</label>
                    <label><input type="checkbox" value="공부하기 좋은" /> 공부하기 좋은</label>
                    <label><input type="checkbox" value="비즈니스 미팅" /> 비즈니스 미팅</label>
                    <label><input type="checkbox" value="애견 동반" /> 애견 동반</label>
                    <label><input type="checkbox" value="분위기 좋은" /> 분위기 좋은</label>
                    <label><input type="checkbox" value="인스타 감성" /> 인스타 감성</label>
                    <label><input type="checkbox" value="풍경이 좋은" /> 풍경이 좋은</label>
                    <label><input type="checkbox" value="새로 오픈" /> 새로 오픈</label>
                    <label><input type="checkbox" value="조용한" /> 조용한</label>
                </div>
                <button onclick="submitEditReview(${review.id})">Submit</button>
                <button onclick="cancelEditReview(${review.id})">Cancel</button>
            `;

            div.appendChild(editForm);
            reviewList.appendChild(div);
        });
    }

    function showEditForm(reviewId) {
        const review = reviewsData.find(r => r.id === reviewId);
        const reviewItem = document.querySelector(`.review-item button[onclick="showEditForm(${reviewId})"]`).parentElement;
        const editForm = reviewItem.querySelector('.edit-form');
        editForm.style.display = 'block';

        document.getElementById(`edit-content-${reviewId}`).value = review.content || '';
        const ratingInput = document.querySelector(`input[name="edit-rating-${reviewId}"][value="${review.score}"]`);

        if (ratingInput) {
            ratingInput.checked = true;
        } else {
            console.warn(`Rating input with value ${review.score} not found.`);
        }

        document.querySelectorAll(`.edit-form .categories input[type="checkbox"]`).forEach(checkbox => {
            if (review.categoryNames.includes(checkbox.value)) {
                checkbox.checked = true;
            } else {
                checkbox.checked = false;
            }
        });
    }

    async function submitEditReview(reviewId) {
        const rating = document.querySelector(`input[name="edit-rating-${reviewId}"]:checked`).value;
        const content = document.getElementById(`edit-content-${reviewId}`).value;
        const categoryNames = Array.from(document.querySelectorAll(`.edit-form .categories input[type="checkbox"]:checked`)).map(checkbox => checkbox.value);

        const reviewData = {
            score: rating,
            content: content,
            categoryNames: categoryNames,
        };

        try {
            const response = await fetch(`/api/review/update/${reviewId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reviewData)
            });

            if (response.ok) {
                alert('Review updated successfully!');
                fetchReviews();
            } else {
                alert('Failed to update review.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update review.');
        }
    }

    function cancelEditReview(reviewId) {
        const reviewItem = document.querySelector(`.review-item button[onclick="showEditForm(${reviewId})"]`).parentElement;
        const editForm = reviewItem.querySelector('.edit-form');
        editForm.style.display = 'none';
    }

    async function deleteReview(reviewId) {
        if (!confirm('정말 리뷰를 삭제하겠습니까?')) {
            return;
        }

        try {
            const response = await fetch(`/api/review/delete/${reviewId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('리뷰가 성공적으로 삭제되었습니다!');
                fetchReviews();
            } else {
                alert('리뷰 삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('리뷰 삭제에 실패했습니다.');
        }
    }

    fetchReviews();
</script>
</body>
</html>
