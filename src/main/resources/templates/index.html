<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Bean Container</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/index.css}">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c1be6dbc09faa31e5316451aad20da0b&libraries=services,geometry"></script>
    <script>
        let map, ps, infowindow, markers = {};
        let lastCenter = null; // 마지막 검색한 중심 좌표

        const districts = {
            '관악구': { lat: 37.4789, lng: 126.9516 },
            '서초구': { lat: 37.4837, lng: 127.0323 },
            '구로구': { lat: 37.4955, lng: 126.8879 }
            // 추가적인 구 좌표를 여기에 추가하세요
        };

        function initMap() {
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780), // 지도의 중심좌표 (서울 시청)
                    level: 3 // 지도의 확대 레벨
                };

            map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

            // 확대/축소 컨트롤을 생성하고 지도에 추가합니다
            var zoomControl = new kakao.maps.ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.LEFT);

            // 장소 검색 객체를 생성합니다
            ps = new kakao.maps.services.Places();

            // 인포윈도우를 생성합니다
            infowindow = new kakao.maps.InfoWindow({zIndex:1});

            // 지도의 드래그가 끝날 때마다 카페를 다시 검색합니다
            kakao.maps.event.addListener(map, 'dragend', function() {
                const center = map.getCenter();
                if (lastCenter && center.equals(lastCenter)) {
                    return; // 중심이 변경되지 않은 경우 검색하지 않음
                }
                lastCenter = center; // 마지막 검색한 중심 좌표 업데이트
                searchPlacesByCenter(center);
            });

            // 지도의 줌 변경이 끝날 때마다 카페를 다시 검색합니다
            kakao.maps.event.addListener(map, 'zoom_changed', function() {
                const center = map.getCenter();
                if (lastCenter && center.equals(lastCenter)) {
                    return; // 중심이 변경되지 않은 경우 검색하지 않음
                }
                lastCenter = center; // 마지막 검색한 중심 좌표 업데이트
                searchPlacesByCenter(center);
            });
        }

        function searchPlacesByCenter(center) {
            const keyword = '카페';

            ps.keywordSearch(keyword, function(data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    // 검색된 장소 위치를 마커로 표시합니다
                    for (var i = 0; i < data.length; i++) {
                        if (!isExcludedCategory(data[i].category_name) && !markers[data[i].id]) {
                            displayMarker(data[i]);
                        }
                    }

                    // 다음 페이지의 결과를 불러옵니다
                    if (pagination.hasNextPage) {
                        pagination.nextPage();
                    }
                }
            }, { location: center, radius: 2000 });
        }

        function isExcludedCategory(categoryName) {
            const excludedCategories = ['보드게임카페', '룸카페', '방탈출카페', '테마카페', '고양이카페', '북카페', '레드버튼', '벌툰', '키즈'];
            return excludedCategories.some(excluded => categoryName.includes(excluded));
        }

        // 지도에 마커를 표시하는 함수입니다
        function displayMarker(place) {
            var marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(place.y, place.x)
            });

            markers[place.id] = marker;

            // 마커에 클릭이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'click', function() {
                // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
                infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                infowindow.open(map, marker);
            });
        }

        function toggleDropdown() {
            var dropdown = document.getElementById('dropdown');
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
            }
        }

        function selectDistrict(district) {
            document.getElementById('dropdown').style.display = 'none';
            if (districts[district]) {
                const center = new kakao.maps.LatLng(districts[district].lat, districts[district].lng);
                map.setCenter(center);
                map.setLevel(3); // 지도 확대 레벨을 3으로 설정
                lastCenter = center; // 마지막 검색한 중심 좌표 업데이트
                searchPlacesByCenter(center);
            }
        }

        function toggleMenu() {
            var menu = document.getElementById("menu");
            if (menu.style.display === "block") {
                menu.style.display = "none";
            } else {
                menu.style.display = "block";
            }
        }

        function closeMenu() {
            var menu = document.getElementById("menu");
            menu.style.display = "none";
        }

        document.addEventListener('click', function(event) {
            var isClickInside = document.getElementById('hamburger').contains(event.target) || document.getElementById('menu').contains(event.target);
            if (!isClickInside) {
                closeMenu();
            }
        });

        window.onload = function() {
            initMap();
            // 초기 지도 위치에서 카페 검색
            searchPlacesByCenter(map.getCenter());
        };
    </script>
</head>
<body>
<div class="header">
    <h1>Bean Container</h1>
    <div id="hamburger" class="hamburger" onclick="toggleMenu()">☰</div>
    <div id="menu" class="menu">
        <a href="#">채팅방</a>
        <a href="/login">login / logout</a>
        <a href="/mypage/{userId}">my page</a>
        <a href="#">save</a>
        <a href="#">지도 만들기</a>
    </div>
</div>
<div class="container">
    <div class="left-section">
        <button onclick="toggleDropdown()">지역토글</button>
        <div id="dropdown" style="display:none;">
            <ul>
                <li onclick="selectDistrict('관악구')">관악구</li>
                <li onclick="selectDistrict('서초구')">서초구</li>
                <li onclick="selectDistrict('구로구')">구로구</li>
                <!-- 추가적인 구를 여기에 추가할 수 있습니다 -->
            </ul>
        </div>
        <div id="map" class="map"></div>
    </div>
    <div class="right-section">
        <div class="filter">filter</div>
        <div class="board-list">
            게시판 리스트
            <ul>
                <li><a href="#">게시글 1</a></li>
                <li><a href="#">게시글 2</a></li>
                <li><a href="#">게시글 3</a></li>
            </ul>
        </div>
        <div class="chat-room">채팅방</div>
    </div>
</div>
</body>
</html>
